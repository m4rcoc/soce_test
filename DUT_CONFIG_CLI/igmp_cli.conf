#!/bin/bash

# NOTE: This is the default configuration for rugged 8x8 (HPS v21.1.9)

function igmp_reset(){

cat <<-EOF > cmds/${test_function}_dut_config_restore.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 0
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH forward
igmp restart
statistics reset_all_statistics SWITCH
EOF

}

function igmp_basic(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH filter
igmp restart
statistics reset_all_statistics SWITCH
EOF
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.1 – 
#-----------------------------------------------------------------------------------------------------------------------------------------


function test_igmp_1_1_restore(){
    igmp_reset
}


#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.2 – 
#-----------------------------------------------------------------------------------------------------------------------------------------


function test_igmp_2_1(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH filter
igmp restart
EOF
}

function test_igmp_2_1_restore(){
    igmp_reset
}

function test_igmp_2_2(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH forward
igmp restart
EOF
}

function test_igmp_2_2_restore(){
    igmp_reset
}


#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.3 – 
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_igmp_3_1(){

    igmp_basic
}

function test_igmp_3_1_restore(){
    igmp_reset
}

function test_igmp_3_2(){
    igmp_basic
}

function test_igmp_3_2_restore(){
    igmp_reset
}


#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.4 – 
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_igmp_4_1(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 10
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH filter
igmp restart
statistics reset_all_statistics SWITCH
EOF
}

function test_igmp_4_1_restore(){
    igmp_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.5 – 
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_igmp_5_1(){

    igmp_basic
}

function test_igmp_5_1_restore(){
    igmp_reset
}

function test_igmp_5_2(){

    igmp_basic
}

function test_igmp_5_2_restore(){
    igmp_reset
}

function test_igmp_5_3(){

    igmp_basic
}

function test_igmp_5_3_restore(){
    igmp_reset
}

function test_igmp_5_4(){

    igmp_basic
}

function test_igmp_5_4_restore(){
    igmp_reset
}

function test_igmp_5_5(){

    igmp_basic
}

function test_igmp_5_5_restore(){
    igmp_reset
}

function test_igmp_5_6(){

    igmp_basic
}

function test_igmp_5_6_restore(){
    igmp_reset
}
#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IGMP.6 – 
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_igmp_6_1(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli << EOF
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp add_querier service_port
igmp add_querier mgmt_port
igmp set_igmp_querier_param service_port ip 0.0.0.0
igmp set_igmp_querier_param service_port expiry 100
igmp set_igmp_querier_param service_port interquery_time 10
igmp set_igmp_querier_param mgmt_port ip 192.168.4.64
igmp set_igmp_querier_param mgmt_port expiry 110
igmp set_igmp_querier_param mgmt_port interquery_time 12
igmp restart
EOF
}

function test_igmp_6_1_restore(){

cat <<-EOF > cmds/${test_function}_dut_config_restore.cmd
soce_cli
igmp delete_querier service_port
igmp delete_querier mgmt_port
igmp delete_querier routing_port_1
igmp delete_querier routing_port_2
igmp delete_querier routing_port_3
igmp set_igmp_snooping_param igmp_snooper_enabled 0
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH forward
igmp restart
statistics reset_all_statistics SWITCH
EOF
}

function test_igmp_6_2(){

cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
igmp set_igmp_snooping_param igmp_snooper_enabled 1
igmp set_igmp_snooping_param igmp_snooper_forget_time 30
igmp set_router_ports SWITCH ""
igmp set_unknown_multicast_frames_behaviour SWITCH filter

vlan set_vlan_port $port_0_config 10 0 0 access all none original none none
vlan set_vlan_port $RT1 10 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 10 10 $port_0_config,$RT1 ""
iface_mgmt add_vlan_iface v10 routing_port_1 10
iface_mgmt set_iface_ipv4_addr v10 static 192.168.5.64 255.255.255.0

vlan set_vlan_port $port_1_config 20 0 0 access all none original none none
vlan set_vlan_port $RT2 20 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 20 20 $port_1_config,$RT2 ""
iface_mgmt add_vlan_iface v20 routing_port_2 20
iface_mgmt set_iface_ipv4_addr v20 static 192.168.6.64 255.255.255.0

vlan set_vlan_port $port_2_config 30 0 0 access all none original none none
vlan set_vlan_port $RT3 30 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 30 30 $port_2_config,$RT3 ""
iface_mgmt add_vlan_iface v30 routing_port_3 30
iface_mgmt set_iface_ipv4_addr v30 static 192.168.7.64 255.255.255.0
iface_mgmt restart
exit
sleep 5
soce_cli
igmp add_querier v10
igmp set_igmp_querier_param v10 ip 192.168.5.64
igmp set_igmp_querier_param v10 expiry 100
igmp set_igmp_querier_param v10 interquery_time 10
igmp add_querier v20
igmp set_igmp_querier_param v20 ip 192.168.6.64
igmp set_igmp_querier_param v20 expiry 100
igmp set_igmp_querier_param v20 interquery_time 11
igmp add_querier v30
igmp set_igmp_querier_param v30 ip 192.168.7.64
igmp set_igmp_querier_param v30 expiry 100
igmp set_igmp_querier_param v30 interquery_time 12
igmp add_querier service_port
igmp set_igmp_querier_param service_port ip 0.0.0.0
igmp set_igmp_querier_param service_port expiry 100
igmp set_igmp_querier_param service_port interquery_time 10
igmp add_querier mgmt_port
igmp set_igmp_querier_param mgmt_port ip 192.168.4.64
igmp set_igmp_querier_param mgmt_port expiry 100
igmp set_igmp_querier_param mgmt_port interquery_time 12
exit
sleep 5
soce_cli
igmp restart
EOF
}


function test_igmp_6_2_restore(){

cat <<-EOF > cmds/${test_function}_dut_config_restore.cmd
echo $password | sudo -S cp /etc/soce_design/factory_config/SW/igmp.json /etc/soce_configs/current/SW/igmp.json
echo $password | sudo -S cp /etc/soce_design/factory_config/SW/iface_mgmt.json /etc/soce_configs/current/SW/iface_mgmt.json
soce_cli
iface_mgmt reload_configuration
iface_mgmt set_iface_ipv4_addr service_port static $ip 255.255.255.0
iface_mgmt restart
igmp reload_configuration
igmp restart
EOF
}