#!/bin/bash

function 8021qci_reset(){

cat <<-EOF > cmds/${test_function}_dut_config_restore.cmd
echo $password | sudo -S cp /etc/soce_design/factory_config/SWITCH/ieee802_1Qci.json /etc/soce_configs/current/SWITCH/ieee802_1Qci.json
echo $password | sudo -S cp /etc/soce_design/factory_config/SWITCH/active_stream_translation.json /etc/soce_configs/current/SWITCH/active_stream_translation.json
echo $password | sudo -S cp /etc/soce_design/factory_config/SWITCH/stream_identification.json /etc/soce_configs/current/SWITCH/stream_identification.json
soce_cli
vlan reset SWITCH
ieee8021qci clear_all_psfp_statistics SWITCH
ieee8021qci reload_configuration SWITCH
stream_identification reload_configuration SWITCH
active_stream_translation reload_configuration SWITCH
EOF
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 1 - Stream Filter: Maximum SDU size filtering
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_1_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 3 3 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 4 4 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:12:01:00:00:01 2 0 tagged
stream_identification set_active_stream_id SWITCH 2 2 00:12:01:00:00:01 3 0 tagged
stream_identification set_active_stream_id SWITCH 2 3 00:12:01:00:00:01 4 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0 
ieee8021qci set_stream_filter_table_entry SWITCH 0 enabled 1000 disabled 0 disabled 0
ieee8021qci enable_global_psfp SWITCH
EOF
}

function test_8021qci_1_1_restore(){

    8021qci_reset
}
#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 2 - Stream Filter: Stream Block
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_2_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 3 3 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 4 4 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:12:01:00:00:01 2 0 tagged
stream_identification set_active_stream_id SWITCH 2 2 00:12:01:00:00:01 3 0 tagged
stream_identification set_active_stream_id SWITCH 2 3 00:12:01:00:00:01 4 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0 
ieee8021qci set_stream_filter_table_entry SWITCH 0 enabled 1000 enabled 0 disabled 0
ieee8021qci reset_stream_blocked_due_to_oversize_frame SWITCH 0
ieee8021qci enable_global_psfp SWITCH
EOF
}

function test_8021qci_2_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 3 - Stream Filter: IPV
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_3_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 3 3 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 4 4 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:12:01:00:00:01 2 0 tagged
stream_identification set_active_stream_id SWITCH 2 2 00:12:01:00:00:01 3 0 tagged
stream_identification set_active_stream_id SWITCH 2 3 00:12:01:00:00:01 4 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0 
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 disabled 0
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 enabled 7
ieee8021qci enable_global_psfp SWITCH
ieee8021qav set_idle_slope $port_1_config 7 50
ieee8021qav enable_cbs $port_1_config 7
EOF
}



function test_8021qci_3_1_restore(){

    8021qci_reset
}

#ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7


#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 4 - Stream Gate: Gate state-based policing
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_4_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 3 3 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 4 4 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:12:01:00:00:01 2 0 tagged
stream_identification set_active_stream_id SWITCH 2 2 00:12:01:00:00:01 3 0 tagged
stream_identification set_active_stream_id SWITCH 2 3 00:12:01:00:00:01 4 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0 
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 disabled 0
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 enabled 7
ieee8021qci enable_global_psfp SWITCH
ieee8021qav set_idle_slope $port_1_config 7 50
ieee8021qav enable_cbs $port_1_config 7
EOF
}

#ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 0 enabled 7

function test_8021qci_4_1_restore(){

    8021qci_reset
}


#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 5 - Flow Meter: color-blind mode
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_5_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 enabled 0
ieee8021qci set_stream_filter_table_entry SWITCH 1 disabled 1000 disabled 1 enabled 1
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7
ieee8021qci set_stream_gate_table_entry SWITCH 1 enabled 1 disabled 7
ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 1000 0 color-blind 0 disabled
ieee8021qci set_flow_meter_table_entry SWITCH 1 1 1000 1000 10000 0 color-blind 0 disabled 
ieee8021qci enable_global_psfp SWITCH
EOF
}

# Flows:
# sh 0 (DEI=1)
# sh 1 (DEI=0)
# Observable results (IXIA):
# sh 0 - Rx Frame Rate = 1001 fps, Port_1 capture - DEI=1 (all)
# sh 1 - Rx FRame Rate = 1001 fps, Port_3 capture - DEI=0 (all)

function test_8021qci_5_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 6 - Flow Meter: color-aware mode
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_6_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 enabled 0
ieee8021qci set_stream_filter_table_entry SWITCH 1 disabled 1000 disabled 1 enabled 1
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7
ieee8021qci set_stream_gate_table_entry SWITCH 1 enabled 1 disabled 7
ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 1000 0 color-aware 0 disabled
ieee8021qci set_flow_meter_table_entry SWITCH 1 1 1000 1000 10000 0 color-aware 0 disabled 
ieee8021qci enable_global_psfp SWITCH
EOF
}

# Flows:
# sh 0 (DEI=0)
# sh 1 (DEI=0)
# Observable results (IXIA):
# sh 0 - Rx Frame Rate = 1 fps, Capture - 1000 DEI=0 + 1 DEI=1
# sh 1 - Rx FRame Rate = 1000 fps, Capture - 1 DEI=0 + 1000 DEI=1

function test_8021qci_6_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 7 - Flow Meter: coupling Mode (CF)
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_7_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 enabled 0
ieee8021qci set_stream_filter_table_entry SWITCH 1 disabled 1000 disabled 1 enabled 1
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7
ieee8021qci set_stream_gate_table_entry SWITCH 1 enabled 1 disabled 7
ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 2000 1 color-aware 0 disabled
ieee8021qci set_flow_meter_table_entry SWITCH 1 1 1000 1000 10000 1 color-aware 0 disabled 
ieee8021qci enable_global_psfp SWITCH
EOF
}

# Flows:
# sh 0 (DEI=0)
# sh 1 (DEI=0)
# Observable results (IXIA):
# sh 0 - Rx Frame Rate = 1001 fps, Port_1 capture - DEI=1 (all)
# sh 1 - Rx FRame Rate = 1001 fps, Port_3 capture - DEI=1 (all)

function test_8021qci_7_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 8 - Flow Meter: Drop on Yellow
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_8_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 enabled 0
ieee8021qci set_stream_filter_table_entry SWITCH 1 disabled 1000 disabled 1 enabled 1
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7
ieee8021qci set_stream_gate_table_entry SWITCH 1 enabled 1 disabled 7
ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 1000 0 color-aware 0 disabled
ieee8021qci set_flow_meter_table_entry SWITCH 1 1 1000 1000 10000 0 color-aware 0 disabled 
ieee8021qci enable_global_psfp SWITCH
EOF
}

# Observable results (IXIA):
# sh 0 - Rx Frame Rate = 1 fps
# sh 1 - Rx FRame Rate = 1000 fps

# ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 1000 0 color-aware 1 disabled

# Observable results (IXIA):
# sh 0 - Rx Frame Rate = 0 fps
# sh 1 - Rx FRame Rate = 1000 fps

function test_8021qci_8_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 9 - Flow Meter: MarkAllFramesRed
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_9_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci set_stream_filter_table_entry SWITCH 0 disabled 1000 disabled 0 enabled 0
ieee8021qci set_stream_filter_table_entry SWITCH 1 disabled 1000 disabled 1 enabled 1
ieee8021qci set_stream_gate_table_entry SWITCH 0 enabled 1 disabled 7
ieee8021qci set_stream_gate_table_entry SWITCH 1 enabled 1 disabled 7
ieee8021qci set_flow_meter_table_entry SWITCH 0 1000 10000 1 1000 0 color-aware 0 enabled
ieee8021qci set_flow_meter_table_entry SWITCH 1 1 1000 1000 10000 0 color-aware 0 disabled 
ieee8021qci reset_mark_all_frames_red SWITCH 0
ieee8021qci reset_mark_all_frames_red SWITCH 1
ieee8021qci enable_global_psfp SWITCH
EOF
}
# RESET MARK ALL FRAMES:

# ieee8021qci reset_mark_all_frames_red SWITCH 0

function test_8021qci_9_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 10 - Metering and Policing Statistics
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_10_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci enable_global_psfp SWITCH
EOF
}

function test_8021qci_10_1_restore(){

    8021qci_reset
}

#-----------------------------------------------------------------------------------------------------------------------------------------
# Test IEEE 802.1Qci 11 - Behaviour for non streams (qci filtering not assigned)
#-----------------------------------------------------------------------------------------------------------------------------------------

function test_8021qci_11_1(){
cat <<-EOF > cmds/${test_function}_dut_config.cmd
soce_cli
vlan set_vlan_port $port_0_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_1_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_2_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_port $port_3_config 1 0 0 trunk all tag-all original none none
vlan set_vlan_entry SWITCH 1 1 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 2 2 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
vlan set_vlan_entry SWITCH 3 3 $port_0_config,$port_1_config,$port_2_config,$port_3_config ""
stream_identification set_active_stream_id SWITCH 2 0 00:12:01:00:00:01 1 0 tagged
stream_identification set_active_stream_id SWITCH 2 1 00:14:01:00:00:01 2 0 tagged
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 0 0 0
ieee8021qci set_stream_filter_transtation_table_entry SWITCH 1 0 1
ieee8021qci enable_global_psfp SWITCH
ieee8021qci clear_all_psfp_statistics SWITCH
EOF
}

function test_8021qci_11_1_restore(){

    8021qci_reset
}
